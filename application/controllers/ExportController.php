<?php
/**
 * SRP
 *
 * Sistema de Registro de Planillas
 *
 * @category   Application
 * @package    Application_Controllers
 * @copyright  Copyright (c) 2010 PCSMEXICO
 * @author     <marlen>, $LastChangedBy$
 * @version    1.0.0 SVN: $Id$
 */

/**
 * Dependences
 */
require_once "lib/controller/CrudController.php";
require_once "lib/managers/ExportManager.php";
require_once "application/models/catalogs/TimetableCatalog.php";
require_once "application/models/catalogs/TimetableHourCatalog.php";
require_once "application/models/catalogs/EmployeeCatalog.php";
require_once "application/models/catalogs/ProjectCatalog.php";
require_once "application/models/catalogs/PersonCatalog.php";
require_once "application/models/catalogs/CalendarDayCatalog.php";
require_once "application/models/catalogs/SpecificProjectCatalog.php";
require_once "application/models/catalogs/DepartmentProjectCatalog.php";
require_once "application/models/catalogs/DepartmentCatalog.php";
require_once "application/models/catalogs/ProjectTaskCatalog.php";

/**
 * ExportController (CRUD for the Export Objects)
 *
 * @category   Project
 * @package    Project_Controllers
 * @copyright  Copyright (c) 2010 PCSMEXICO 
 * @copyright  This File has been proudly generated by Bender (http://code.google.com/p/bender-modeler/). <chentepixtol> <zetta>
 * @author     <zetta> & <chentepixtol>
 * @version    1.0.0 SVN: $Revision$
 */
class ExportController extends BaseController
{
    
    /**
     * Recibe los parámetros de búsqueda
     */
    public function findAction()
    {
    	$startWeek = mktime();
		$endWeek = mktime();
		while(date("w",$startWeek)!=1){
			$startWeek -= 3600;
		}
		while(date("w",$endWeek)!=0){
			$endWeek += 3600;
		}
		$startDay = date("Y-m-d",$startWeek);
		$endDay = date("Y-m-d",$endWeek);    	
    	$start = $this->getRequest()->getParam('startp');
    	$end = $this->getRequest()->getParam('endp');  
    	if($start == null)
    		$this->view->startDate = $startDay;
    	else 
    		$this->view->startDate = $start;
    		
    	if ($end == null)
    		$this->view->endDate = $endDay;
    	else 
    		$this->view->endDate = $end;    		    	
    	$this->setTitle('Exportar Archivo Baan');
        $this->view->setTpl('Find');        
    }
    
    /**
     * Exporta los datos al archivo Baan
     */
    public function excelAction()
    {
    	require_once 'excel/ExcelExt.php';
    	
    	$startDate = $this->getRequest()->getParam('startp');
    	$this->view->startDate = $startDate;
    	$endDate = $this->getRequest()->getParam('endp');
    	$this->view->endDate = $endDate;
    	$export = ExportManager::getInstance()->getTimetables($startDate,$endDate);
       	$excel=ExcelExt::createExcel("Archivo Baan".date("Y-m-d").".xls", $export);
       	$this->noRender();   	
    }
}